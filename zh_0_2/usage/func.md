<!-- toc -->

# 报警函数说明

配置报警策略的时候open-falcon支持多种报警触发函数，比如`all(#3)` `diff(#10)`等等。
这些#后面的数字表示的是最新的历史点，比如`#3`代表的是最新的三个点。该数字默认不能大于`10`，大于`10`将当作`10`处理，即只计算最新`10`个点的值。

说明：`#`后面的数字的最大值，即在 judge 内存中保留最近几个点，是支持自定义的，具体参考 book 中[描述](http://book.open-falcon.com/zh_0_2/distributed_install/judge.html) ； 源码位置 => [cfg.example.json](https://github.com/open-falcon/falcon-plus/blob/master/modules/judge/cfg.example.json#L4:6)

```bash
all(#3): 最新的3个点都满足阈值条件则报警
max(#3): 对于最新的3个点，其最大值满足阈值条件则报警
min(#3): 对于最新的3个点，其最小值满足阈值条件则报警
sum(#3): 对于最新的3个点，其和满足阈值条件则报警
avg(#3): 对于最新的3个点，其平均值满足阈值条件则报警
diff(#3): 拿最新push上来的点（被减数），与历史最新的3个点（3个减数）相减，得到3个差，只要有一个差满足阈值条件则报警
pdiff(#3): 拿最新push上来的点，与历史最新的3个点相减，得到3个差，再将3个差值分别除以减数，得到3个商值，只要有一个商值满足阈值则报警
lookup(#2,3): 最新的3个点中有2个满足条件则报警；
stddev(#7) = 3：离群点检测函数，取最新 **7** 个点的数据分别计算得到他们的标准差和均值，分别计为 σ 和 μ，其中当前值计为 X，那么当 μ-3σ <= X <= μ+3σ 时，则认为当前值波动过大，触发报警；更多请参考3-sigma算法：https://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule。

```

最常用的就是`all`函数了，比如cpu.idle `all(#3) < 5`，表示cpu.idle的值连续3次小于5%则报警。

`lookup`为非连续性报警函数，适用于在一定范围内容忍监控指标抖动的场景，比如某个主机的cpu.busy忽高忽低，使用`all(#1)>80`明显过于严格，会产生大量报警干扰视线，使用`all(#3)>80`则连续三次偏高的概率很小，可能永远不会触发报警，不能帮助我们发现系统的不稳定，那么如果使用`lookup(#3,5)`，我们就可以知道cpu.busy最近抖动频繁，超过了我们容忍的界线。

新增 `stddev` 函数，基于高斯分布的离群点检测方式，比如cpu.idle `stddev(#5) = 3` ，表示获取cpu.idle的历史5个点数据，计算得到他们的标准差和均值，分别计为 σ 和 μ，看其是否分布在`(μ-3σ,μ+3σ)`范围之内，如果不在范围之内则报警。具体参考wiki中[描述](https://zh.wikipedia.org/wiki/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83)

diff和pdiff理解起来没那么容易，设计diff和pdiff是为了解决流量突增突降报警。实在看不懂，那只能去读代码了：https://github.com/open-falcon/judge/blob/master/store/func.go




